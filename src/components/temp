<template>
  <div
    class="player-container"
    ref="playerContainer"
    @mouseleave="showSetting = false"
  >
    <div class="video-box">
      <video ref="videoPlayer" loop="true" @click="toggleVideo"></video>
    </div>
    <div class="video-box-bottom">
      <div class="setting-con" v-if="showSetting">
        <div class="nothing" @click="showSetting = false"></div>
        <div class="setting-box">
          <div class="menu" ref="settingBmenu">
            <div class="item" @click="showPlayRate">
              <div class="left">
                <img src="@/assets/icon/速度.png" /><span>播放速度</span>
              </div>
              <div class="right">
                <span>1x</span><img src="@/assets/icon/右箭头.png" />
              </div>
            </div>
            <div class="item">
              <div class="left">
                <img src="@/assets/icon/清晰度.png" /><span>清晰度</span>
              </div>
              <div class="right">
                <span>720p</span><img src="@/assets/icon/右箭头.png" />
              </div>
            </div>
          </div>
          <div class="playrate-box" ref="playerRateBox">
            <div class="item" @click="initPlayRate">退出</div>
            <div class="item">0.5</div>
            <div class="item">0.75</div>
            <div class="item">1.0</div>
            <div class="item">1.25</div>
            <div class="item">1.5</div>
            <div class="item">2.0</div>
          </div>
        </div>
      </div>
      <div
        class="progress"
        ref="progressBar"
        @click="gotoHere"
        @mousedown="startDragging"
        @mousemove="drag"
        @mouseup="stopDragging"
        @mouseleave="stopDragging"
      >
        <div class="preload" ref="preloadBar"></div>
        <div class="now" ref="nowBar"></div>
      </div>
      <div class="controll">
        <div class="left">
          <div class="play" @click="toggleVideo">
            <img src="../assets/icon/播放.png" alt="" ref="playImg" />
          </div>
          <div class="volume">
            <img src="@/assets/icon/音量.png" />
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              step="1"
              @input="changeVolume"
            />
          </div>
          <div class="time">
            <span ref="nowTime">00:00</span>
            <span>/</span>
            <span ref="totalTime">00:00</span>
          </div>
        </div>
        <div class="right">
          <div class="icon setting">
            <img
              src="@/assets/icon/白设置.png"
              @click="showSetting = !showSetting"
            />
          </div>
          <div class="icon window">
            <img src="@/assets/icon/小窗口.png" @click="fullscrean" />
          </div>
          <div class="icon browserfull">
            <img src="@/assets/icon/网页全屏.png" @click="fullscrean" />
          </div>
          <div class="icon fullscrean">
            <img src="@/assets/icon/全屏.png" @click="fullscrean" />
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from "vue";
import Hls from "hls.js/dist/hls.min.js";
let testSrc =
  "http://localhost:3000/1680508992107/360p/1680508992107_360p.m3u8";
const videoPlayer = ref();
const playerContainer = ref();
const progressBar = ref();
const nowBar = ref();
const preloadBar = ref();
const totalTime = ref();
const nowTime = ref();
const playImg = ref();
const settingBmenu = ref();
const playerRateBox = ref();
let timer: any = null;
let showSetting = ref(false);
let countTimer: any = null;
let loadedFragments: any = [];
let isDragging = ref(false);
const hls = new Hls();
onMounted(() => {
  setInfo();
});
function showPlayRate() {
  settingBmenu.value.style.height = "0";
  settingBmenu.value.style.width = "0";
  playerRateBox.value.style.width = "250px";
  playerRateBox.value.style.height = "auto";
}
function initPlayRate() {
  settingBmenu.value.style.width = "250px";
  settingBmenu.value.style.height = "auto";
  playerRateBox.value.style.width = "0";
  playerRateBox.value.style.height = "0";
}
function changeVolume(e: Event) {
  const volumeSlider = e.target as HTMLInputElement;
  videoPlayer.value.volume = parseInt(volumeSlider.value) / 100;
}
function setProgress(
  cur: number,
  total: number,
  width: number,
  dom: HTMLElement
) {
  let percent = (cur / total) * width;
  dom.style.width = percent + "px";
}
function updateProgress() {
  const player = videoPlayer.value;
  const pcon = playerContainer.value;
  const pconWidth = pcon.clientWidth;
  const now = nowBar.value;
  setProgress(player.currentTime, player.duration, pconWidth, now);
}
function updatePreloadProgress(loadedFragments: any, totalFragments: any) {
  const pcon = playerContainer.value;
  const pconWidth = pcon.clientWidth;
  const preload = preloadBar.value;
  setProgress(loadedFragments, totalFragments, pconWidth, preload);
}
function setInfo() {
  if (Hls.isSupported()) {
    hls.loadSource(testSrc); // 替换为你的m3u8文件路径
    hls.attachMedia(videoPlayer.value);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      videoPlayer.value.volume = 0.5;
    });
    hls.on(Hls.Events.FRAG_LOADED, (event: any, data: any) => {
      // 计算加载的片段数量
      console.log(event);
      if (!loadedFragments.includes(data.frag.sn)) {
        loadedFragments.push(data.frag.sn);
      }
      // 获取总片段数量
      if (hls.levels && hls.levels[hls.currentLevel]) {
        const totalFragments =
          hls.levels[hls.currentLevel].details.fragments.length;
        // 更新预加载进度条
        console.log(loadedFragments.length, totalFragments);
        updatePreloadProgress(loadedFragments.length, totalFragments);
      } else {
        console.warn("Unable to access level details");
      }
    });
    hls.on(Hls.Events.ERROR, (event: any, data: any) => {
      console.error("Error event:", event, "Data:", data);
    });
  } else if (videoPlayer.value.canPlayType("application/vnd.apple.mpegurl")) {
    videoPlayer.value.addEventListener("loadedmetadata", () => {
      timer = setInterval(updateProgress, 10);
    });
  } else {
    console.error("该浏览器不支持HLS播放");
  }
}
function toggleVideo() {
  showSetting.value = false;
  if (videoPlayer.value.paused) {
    setall();
    playImg.value.src = getAssetsImages("../assets/icon/暂停.png");
    videoPlayer.value.play();
  } else {
    clearAll();
    playImg.value.src = getAssetsImages("../assets/icon/播放.png");
    videoPlayer.value.pause();
  }
}
function getAssetsImages(url: string) {
  return new URL(url, import.meta.url).href;
}
function setTime() {
  const player = videoPlayer.value;
  const total = totalTime.value;
  const now = nowTime.value;
  const totalMin = Math.floor(player.duration / 60);
  const totalSec = Math.floor(player.duration % 60);
  const nowMin = Math.floor(player.currentTime / 60);
  const nowSec = Math.floor(player.currentTime % 60);
  total.innerHTML = `${totalMin < 10 ? "0" + totalMin : totalMin}:${
    totalSec < 10 ? "0" + totalSec : totalSec
  }`;
  now.innerHTML = `${nowMin < 10 ? "0" + nowMin : nowMin}:${
    nowSec < 10 ? "0" + nowSec : nowSec
  }`;
}
function fullscrean() {
  const playerContainer = videoPlayer.value.closest(".player-container");
  const requestFullScreenMethods = [
    "requestFullscreen",
    "webkitRequestFullscreen",
    "mozRequestFullScreen",
    "msRequestFullscreen",
  ];
  for (const method of requestFullScreenMethods) {
    if (playerContainer[method]) {
      playerContainer[method]();
      break;
    }
  }
}
function setall() {
  timer = setInterval(updateProgress, 10);
  countTimer = setInterval(setTime, 10);
}
function clearAll() {
  clearInterval(countTimer);
  clearInterval(timer);
}
function gotoHere(e: MouseEvent) {
  if (videoPlayer.value.currentTime <= 0) return;
  let cur = e.offsetX / progressBar.value.clientWidth;
  videoPlayer.value.currentTime = cur * videoPlayer.value.duration;
  updateProgress();
}
function startDragging(e: MouseEvent) {
  if (videoPlayer.value.currentTime <= 0) return;
  isDragging.value = true;
}
function drag(e: MouseEvent) {
  if (!isDragging.value) return;
  let offsetX = Math.min(Math.max(e.offsetX, 0), progressBar.value.clientWidth);
  let cur = offsetX / progressBar.value.clientWidth;
  videoPlayer.value.currentTime = cur * videoPlayer.value.duration;
  updateProgress();
}
function stopDragging(e: MouseEvent) {
  if (!isDragging.value) return;
  isDragging.value = false;
}
onUnmounted(() => {
  clearInterval(timer);
  hls.destroy();
});
</script>

<style lang="scss" scoped>
.player-container {
  user-select: none;
  position: relative;
  width: 100%;
  &:hover {
    .video-box-bottom .controll {
      height: 45px;
    }
  }

  .video-box {
    width: 100%;
    video {
      width: 100%;
    }
  }
  .video-box-bottom {
    padding: 0px;
    transition: padding;
    width: 100%;
    bottom: 0;
    position: absolute;
    .setting-con {
      padding-right: 12px;
      width: 100%;
      display: flex;
      justify-content: end;
      .nothing {
        flex: 1;
        height: 100%;
      }
      .setting-box {
        border-radius: 20px;
        overflow: hidden;
        display: flex;
        background: rgba(5, 5, 5, 0.815);
      }
      .menu {
        transition: 1s all;
        background: rgba(5, 5, 5, 0.815);
        width: 250px;
        .item {
          &:hover {
            background: rgba(52, 52, 52, 0.815);
          }
          height: 45px;
          padding: 0 10px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          border-bottom: 1px solid black;
          cursor: pointer;
          span {
            font-size: 12px;
          }
          .left {
            display: flex;
            align-items: center;
            img {
              width: 28px;
              height: 28px;
              margin-right: 10px;
            }
          }
          .right {
            display: flex;
            align-items: center;
            img {
              width: 20px;
              height: 20px;
              margin-right: 10px;
            }
          }
        }
      }
      .playrate-box {
        width: 0;
        height: 0;
        transition: 1s all;
        background: rgba(5, 5, 5, 0.815);
        .item {
          &:hover {
            background: rgba(52, 52, 52, 0.815);
          }
          height: 45px;
          padding: 0 20px;
          display: flex;
          align-items: center;
          width: 100%;
          border-bottom: 1px solid black;
          cursor: pointer;
        }
      }
    }
    .progress {
      &:hover {
        height: 8px;
        .now {
          height: 8px;
          background: #ff0000;
          &::after {
            opacity: 1;
          }
        }
        .preload {
          height: 8px;
        }
      }
      cursor: pointer;
      height: 5px;
      width: 100%;
      position: relative;
      background-color: rgba(211, 211, 211, 0.432);
      .now {
        width: 0;
        height: 5px;
        background-color: rgb(186, 4, 4);
        transition: width 10ms;
        display: flex;
        align-items: center;
        position: absolute;
        top: 0;
        left: 0;
        &::after {
          opacity: 0;
          content: "";
          position: absolute;
          right: -5px;
          width: 15px;
          height: 15px;
          border-radius: 50%;
          background-color: rgb(255, 5, 5);
        }
      }
      .preload {
        width: 0;
        height: 5px;
        background-color: rgba(255, 255, 255, 0.5);
        transition: width 10ms;
        position: absolute;
        top: 0;
        left: 0;
      }
    }
    .controll {
      bottom: 0;
      height: 0px;
      transition: height;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: rgba(0, 0, 0, 0.482);
      .left {
        display: flex;
        align-items: center;
        height: 100%;
        .time {
          font-size: 16px;
          font-weight: 600;
        }
        .play {
          cursor: pointer;
          margin-right: 10px;
          width: 45px;
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100%;
          img {
            width: 24px;
            height: 24px;
          }
        }
        .volume {
          &:hover {
            .volume-slider {
              width: 100px;
              opacity: 1;
            }
          }
          cursor: pointer;
          display: flex;
          align-items: center;
          margin-right: 12px;
          height: 100%;
          img {
            width: 24px;
            height: 24px;
          }
          .volume-slider {
            &:focus {
              outline: none;
            }

            cursor: pointer;
            margin-left: 10px;
            width: 0px;
            opacity: 0;
            transition: width 0.5s;
            height: 3px;
            &::-webkit-slider-runnable-track {
              -webkit-appearance: none;
              width: 100%;
              height: 5px;
              background: #ffffff;
              border-radius: 20px;
            }
            &::-webkit-slider-thumb {
              -webkit-appearance: none;
              margin-top: -5px;
              height: 15px;
              width: 15px;
              border-radius: 50%;
              background-color: #ffffff;
              cursor: pointer;
            }
          }
        }
      }
      .right {
        display: flex;
        align-items: center;
        height: 100%;

        .icon {
          cursor: pointer;
          width: 28px;
          height: 100%;
          display: flex;
          align-items: center;
          margin-right: 12px;
          img {
            width: 28px;
            height: 28px;
          }
        }
      }
    }
  }
}
</style>
